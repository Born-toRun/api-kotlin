name: Kotlin CI with Gradle

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  # ë¹Œë“œí•˜ê³  ë„ì»¤í—ˆë¸Œì— í‘¸ì‹œ
  build-docker-image:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    # build
    - name: Build with Gradle
      uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
      with:
        arguments: clean asciidoctor build

    # TODO: ì™œì¸ì§€ ëª¨ë¥´ê² ìœ¼ë‚˜ git actionsì—ì„œ buildí•˜ë©´ docs copyê°€ ì‹¤í–‰ì´ ì•ˆë¨
    - name: static directory exists
      run: mkdir -p build/resources/main/static/swagger
    - name: copy rest docs
      run: cp build/docs/asciidoc/index.html build/resources/main/static
    - name: copy swagger docs
      run: cp -R build/swagger-ui-swaggerSource/* build/resources/main/static/swagger

    # ë””ë²„ê·¸
    - name: List build directory
      run: ls -R build/resources/main

    # docker hub login
    - name: docker login
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # Set up Docker Buildx (ë©€í‹° í”Œë«í¼ ë¹Œë“œë¥¼ ìœ„í•´)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # docker image build and push (ë©€í‹° í”Œë«í¼)
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: docker/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/b2r-api:latest

    # discord notify
    - name: discord ì•Œë¦¼ ì „ì†¡
      if: success() || failure()
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        DISCORD_EMBEDS: |
            [
                { 
                  "title": "ğŸš€ GitHub Actions ë¹Œë“œ ê²°ê³¼",
                  "color": 10609311,
                  "description": "${{ github.event.issue.html_url }}",
                  "fields": [
                    {
                      "name": "ğŸ“‚ ë¦¬í¬ì§€í† ë¦¬",
                      "value": "${{ github.repository }}",
                      "inline": true
                    },
                    {
                      "name": "ğŸŒ¿ ë¸Œëœì¹˜",
                      "value": "${{ github.ref }}",
                      "inline": true
                    },
                    {
                      "name": "âœ… ìƒíƒœ",
                      "value": "${{ job.status }}",
                      "inline": true
                    },
                    {
                      "name": "ğŸ”— ë¹Œë“œ ë¡œê·¸",
                      "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "inline": true
                    }
                  ]
                }
              ]
      with:
        args: '${{ github.repository }} GitHub Actions ë¹Œë“œ ì™„ë£Œ.'
